---
title: "Dexamethasone treatment to COVID patients"
output:
  pdf_document: default
  html_document:
    df_print: paged
  toc: TRUE
---

```{r, echo = F}
knitr::opts_chunk$set(warning = F, message = F)
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
#knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)

```

```{r load_libraries, echo = F, message = F, warning = F}
library(readxl)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(reshape2)
library(broom)
library(stringr)
#library(ggstatsplot)
```

```{r load_datasets}
# delta alpha clinical table
PNT <- read_excel("../2021-09-23_Dexa_Charite_UKK_all results Alpha and Delta clinical.xlsx") %>% 
  select("Studie 1",
         "PatID Studie 1", 
         "Tag PSO", 
         "Days", 
         "Dexamethason", 
         "Serum ID50: Variant B.1.1.7", 
         "Serum ID50: Variant B.1.617.2") %>%
  rename(PatID_Studie1 = `PatID Studie 1`, 
         TagPSO = `Tag PSO`,
         B.1.1.7 = `Serum ID50: Variant B.1.1.7`, 
         B.1.617.2 = `Serum ID50: Variant B.1.617.2`,
         Dexa = Dexamethason) %>%
  mutate(PatID_Studie1 = str_replace(PatID_Studie1, c("C19-CB-"), "")) %>% 
  mutate(PatID_Studie1 = as.character(as.numeric(PatID_Studie1))) %>% 
  filter(!(Days == "nd")) %>%
  filter(!(PatID_Studie1 == "435")) %>% 
  #mutate(TagPSO = replace(TagPSO, PatID_Studie1=="435", "6")) %>% 
  mutate(TagPSO = as.numeric(TagPSO)) %>% 
  mutate(PatID_Studie1 = tolower(paste(substr(`Studie 1`, 1, 2), PatID_Studie1, sep = "")))

# FACS results
facs <- read_excel("../20211014 Mastertable FACS results LB final.xlsx") %>% 
  select("Studie 1", 
         "PatID Studie 1", 
         "Zeitraum 2021 09 03 und post Impfung W3-6", 
         "Tag PSO", 
         "Dexa", 
         "Marker 1", 
         "Marker 2", 
         "#CEFX-unstim negativ auf 0", 
         "#S1-unstim negativ auf 0", 
         "#S2-unstim negativ auf 0", 
         "#SEB-unstim negativ auf 0",
         "ausschliessen") %>%
  mutate(ausschliessen = replace_na(ausschliessen, 0)) %>% 
  rename(Studie1 = `Studie 1`, 
         PatID_Studie1 = `PatID Studie 1`, 
         Timepoint = `Zeitraum 2021 09 03 und post Impfung W3-6`,
         TagPSO = `Tag PSO`, 
         Marker1 = `Marker 1`, 
         Marker2 = `Marker 2`) %>%
  rename(CEFX = `#CEFX-unstim negativ auf 0`, 
         S1 = `#S1-unstim negativ auf 0`, 
         S2 = `#S2-unstim negativ auf 0`, 
         SEB = `#SEB-unstim negativ auf 0`) %>%
  filter(!is.na(CEFX) | !is.na(S1) | !is.na(S2) | !is.na(SEB)) %>%
  mutate(PatID_Studie1 = as.character(PatID_Studie1)) %>% 
  #mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153"|
           PatID_Studie1 == "435")) %>% 
  filter(!(ausschliessen == 1)) %>% 
  mutate(PatID_Studie1 = tolower(paste(substr(Studie1, 1, 2), PatID_Studie1, sep = "")))

facs_live <- read_excel("../2021128 Mastertable FACS results inkl. dead cells_LB.xlsx") %>% 
  select("Studie 1", 
         "PatID Studie 1", 
         "Zeitraum 2021 09 03 und post Impfung W3-6", 
         "Tag PSO", 
         "Dexa", 
         "Marker 1", 
         "Marker 2", 
         "S1",
         "SEB",
         "ausschliessen") %>%
  mutate(ausschliessen = replace_na(ausschliessen, 0)) %>% 
  rename(Studie1 = `Studie 1`, 
         PatID_Studie1 = `PatID Studie 1`, 
         Timepoint = `Zeitraum 2021 09 03 und post Impfung W3-6`,
         TagPSO = `Tag PSO`, 
         Marker1 = `Marker 1`, 
         Marker2 = `Marker 2`) %>%
  filter(!is.na(S1)) %>%
  mutate(PatID_Studie1 = as.character(PatID_Studie1)) %>% 
  #mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153"|
           PatID_Studie1 == "435")) %>% 
  filter(!(ausschliessen == 1)) %>% 
  # takes the first and last character of the study to make ID, unlike others
  mutate(PatID_Studie1 = tolower(paste(substr(Studie1, 1, 1), substr(Studie1, nchar(Studie1), nchar(Studie1)), PatID_Studie1, sep = "")))


# meta data
meta <- read_excel("../Metadaten_FACS_PNT_2021 10 22_CT.xlsx") %>%
  rename(PatID_Studie1 = `PatID Studie 1 kurz`, 
         Age = `Alter / Geschaetztes Alter bei Einschluss gr 3 Jahre`, 
         Sex = `Geschlecht bei der Geburt` ,
         WHO = `#WHO max`, 
         Charlson = `#Charlson Comorbidity Index STP`,
         VacDaysDiff = `#DateDiff Impfung PSO`) %>%
  mutate(PatID_Studie1 = as.character(PatID_Studie1)) %>% 
  filter(!grepl(.$Bemerkung, pattern = "Immun", ignore.case = T)) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153"|
           PatID_Studie1 == "435")) %>% 
  mutate(PatID_Studie1 = tolower(paste(substr(`Studie 1`, 1, 2), PatID_Studie1, sep = "")))

# serology
sero <- read_excel("../Results_20211006_post vacc corrected CT_LB.xlsx") %>% 
  rename(PatID_Studie1 = `PatID Studie 1`,
         IgG = `IgG BAU/ml`,
         TagPSO = `Tag PSO`, 
         Timepoint = Zeitraum, 
         Dexa = `Dexamethason0 = no1 = yes3 = not applicable`,
         ausschliessen_imm = `ausschliessen (Immunsuppression)`) %>% 
  mutate(ausschliessen_imm = replace_na(ausschliessen_imm, 0)) %>%
  mutate(PatID_Studie1 = str_replace(PatID_Studie1, c("C19-CB-"), "")) %>% 
  mutate(PatID_Studie1 = as.character(as.numeric(PatID_Studie1))) %>% 
  mutate(IgG = as.numeric(str_replace(IgG, c(","), "\\."))) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153" |
           PatID_Studie1 == "435")) %>% 
  filter(!ausschliessen_imm == 1) %>% 
  #mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) %>% 
  mutate(PatID_Studie1 = tolower(paste(substr(`COVID Group`, 1, 2), PatID_Studie1, sep = "")))

SRT <- c("S1", "S2", "CEFX", "SEB")
strain <- c("B.1.1.7", "B.1.617.2")
level_order <- c('1', '0', '3')

## How many patients have at least three time points in each measurement.
facs_pat_3timepoints <- facs %>%
  select(PatID_Studie1, Timepoint) %>%
  distinct() %>%
  group_by(PatID_Studie1) %>%
  mutate(number_of_FACS_timepoints = n()) %>%
  mutate(measured_at = paste0(Timepoint, collapse = ", ")) %>%
  select(!Timepoint) %>%
  distinct()
# write.table(facs_pat_3timepoints, "FACS_measurement_timepoints.tsv", row.names = F, quote = F, sep = "\t")
# 
PNT_pat_3timepoints <- PNT %>%
  select(PatID_Studie1, Days) %>%
  distinct() %>%
  group_by(PatID_Studie1) %>%
  mutate(number_of_PNT_timepoints = n()) %>%
  mutate(measured_at = paste0(Days, collapse = ", ")) %>%
  select(!Days) %>%
  distinct()
# write.table(PNT_pat_3timepoints, "PNT_measurement_timepoints.tsv", row.names = F, quote = F, sep = "\t")
# 
sero_pat_3timepoints <- sero %>%
  select(PatID_Studie1, Timepoint) %>%
  distinct() %>%
  group_by(PatID_Studie1) %>%
  mutate(number_of_Sero_timepoint = n()) %>%
  mutate(measured_at = paste0(Timepoint, collapse = ", ")) %>%
  select(!Timepoint) %>%
  distinct()
# write.table(sero_pat_3timepoints, "Serology_measurement_timepoints.tsv", row.names = F, quote = F, sep = "\t")

```

\pagebreak

## IgG levels vs Age, Sex

```{r sero_meta}
# cor IgG vs Age, sex, Dexa
Sero_meta <- sero %>% 
  left_join(., meta, by = "PatID_Studie1") %>% 
  left_join(., PNT, by = c("PatID_Studie1", "Dexa")) %>% 
  select(PatID_Studie1, Age, Sex, Timepoint, IgG, Dexa) %>% 
  distinct() %>% 
  filter(!(PatID_Studie1 == "183")) %>% 
  mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2"))

Sero_meta %>% 
  filter(Timepoint == "W 2") %>% 
  ggplot(., aes(x = IgG, y = Age)) + 
  geom_point(alpha = 0.5, aes(color = factor(Dexa))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
  stat_cor(method = "spearman", size = 3) +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs Age at timepoint W2")

Sero_meta %>% 
  filter(Timepoint == "M2-4") %>% 
  ggplot(., aes(x = IgG, y = Age)) + 
  geom_point(alpha = 0.5, aes(color = factor(Dexa))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
  stat_cor(method = "spearman", size = 3) +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs Age at timepoint M2-4")

Sero_meta %>% 
  filter(Timepoint == "after month 5") %>% 
  ggplot(., aes(x = IgG, y = Age)) + 
  geom_point(alpha = 0.5, aes(color = factor(Dexa))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
  stat_cor(method = "spearman", size = 3) +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs Age after month 5")

Sero_meta %>% 
  filter(Timepoint == "post vacc") %>% 
  ggplot(., aes(x = IgG, y = Age)) + 
  geom_point(alpha = 0.5, aes(color = factor(Dexa))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
  stat_cor(method = "spearman", size = 3) +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs Age post vacc")

my_comparisons <- list(c("Männlich", "Weiblich"))
# Sero_meta %>% 
#   filter(!is.na(Sex)) %>% 
#   ggplot(., aes(x = Sex, y = IgG)) + 
#   geom_violin(alpha = 0.7) + 
#   geom_jitter(width = 0.1, alpha = 0.5, aes(color = factor(Dexa))) +
#   labs(col = "Dexa") +
#   scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#   stat_compare_means(comparisons = my_comparisons) +
#   theme_bw() +
#   theme(strip.background =element_rect(fill="aliceblue")) +
#   ggtitle("Sex vs IgG")

Sero_meta %>% 
  filter(!is.na(Sex)) %>% 
  ggplot(., aes(x = Sex, y = IgG)) + 
  geom_violin(alpha = 0.5) +
  geom_jitter(width = 0.1, aes(color = factor(Dexa))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  ggtitle("Sex vs IgG") +
  facet_grid(~factor(Timepoint, level = c('W 2', 'W3-6', 'M2-4', 
                                          'after month 5', 'post vacc'))) +
  stat_compare_means(comparisons = my_comparisons) +
  theme_bw() +
  theme(strip.background = element_rect(fill="aliceblue"))
  
Sero_meta %>% 
  #filter(!is.na(Sex)) %>% 
  ggplot(., aes(x = factor(Dexa, levels = level_order), y = IgG)) + 
  geom_violin(alpha = 0.5) +
  geom_jitter(width = 0.1, aes(color = factor(Dexa))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_grid(~factor(Timepoint, level = c('W 2', 'W3-6', 'M2-4', 
                                          'after month 5', 'post vacc'))) +
  stat_compare_means(method = "wilcox.test", comparisons = list(c("0", "3")), 
                     label.y = 15000, size = 2.5) +
  stat_compare_means(method = "wilcox.test", comparisons = list(c("0", "1")), 
                     label.y = 15400, size = 2.5) +
  stat_compare_means(method = "wilcox.test", comparisons = list(c("1", "3")), 
                     label.y = 15900, size = 2.5) +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  xlab("Dexa levels: 1 = Dexa, 0 = no Dexa, 3 = mild") +
  ggtitle("Dexa vs IgG")

```

## Sex vs SRT

```{r}

SRT <- c("S1", "S2", "SEB", "CEFX")
my_comparisons <- list(c("Männlich", "Weiblich"))

facs %>%
  left_join(., meta) %>% 
  select(PatID_Studie1, Timepoint, Marker1, Marker2, S1, S2, SEB, CEFX, Sex, Dexa) %>% 
  mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) -> SRT_sex

# CD4

# for(i in SRT)
#   print(
#     SRT_sex %>%
#       filter(!is.na(Sex)) %>%
#       filter(Marker1 == "CD4") %>% 
#       as.data.frame() %>%
#       filter(!is.na(!!sym(i))) %>%
#         ggplot(aes(x = Sex, y = !!sym(i))) +
#           #geom_point(alpha = 0.7) + 
#           geom_violin() + 
#           geom_jitter(width = 0.1, alpha = 0.5,
#                                       aes(color = factor(Dexa))) + 
#       labs(col = "Dexa") +
#           scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#           geom_boxplot(width=.1, alpha = 0.2, outlier.shape = NA) +
#           theme_bw() +
#           ggtitle(paste0("Sex vs ", i, " (CD4)")) +
#           ylab(i) + 
#           scale_y_log10() +
#           stat_compare_means(comparisons = my_comparisons,
#                              size = 4)
#   )
# 
# # CD8
# 
# for(i in SRT)
#   print(
#     SRT_sex %>%
#       filter(!is.na(Sex)) %>%
#       filter(Marker1 == "CD8") %>% 
#       as.data.frame() %>%
#       filter(!is.na(!!sym(i))) %>%
#         ggplot(aes(x = Sex, y = !!sym(i))) +
#           #geom_point(alpha = 0.7) + 
#           geom_violin() + geom_jitter(width = 0.1, alpha = 0.5,
#                                       aes(color = factor(Dexa))) + 
#           labs(col = "Dexa") +
#           scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#           geom_boxplot(width=.1, alpha = 0.2, outlier.shape = NA) +
#           theme_bw() +
#           ggtitle(paste0("Sex vs ", i, " (CD8)")) +
#           ylab(i) + 
#           scale_y_log10() +
#           stat_compare_means(comparisons = my_comparisons,
#                              size = 4)
#   )
```



```{r fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
for(i in SRT)
  print(
    SRT_sex %>%
      filter(!is.na(Sex)) %>%
      filter(Marker1 == "CD4") %>% 
      as.data.frame() %>%
      filter(!is.na(!!sym(i))) %>%
        ggplot(aes(x = Sex, y = !!sym(i))) +
          #geom_point(alpha = 0.7) + 
          geom_violin() + 
          geom_jitter(width = 0.1, alpha = 0.5,
                                      aes(color = factor(Dexa))) + 
          labs(col = "Dexa") +
          scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
          geom_boxplot(width=.1, alpha = 0.2, outlier.shape = NA) +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                     scales = "free_y") +
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle(paste0("Sex vs ", i, " (CD4)")) +
          ylab(i) + 
          scale_y_log10() +
          stat_compare_means(comparisons = my_comparisons,
                             size = 3.5)
  )


for(i in SRT)
  print(
    SRT_sex %>%
      filter(!is.na(Sex)) %>%
      filter(Marker1 == "CD8") %>% 
      as.data.frame() %>%
      filter(!is.na(!!sym(i))) %>%
        ggplot(aes(x = Sex, y = !!sym(i))) +
          #geom_point(alpha = 0.7) + 
          geom_violin() + geom_jitter(width = 0.1, alpha = 0.5,
                                      aes(color = factor(Dexa))) +
          labs(col = "Dexa") +
          scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
          geom_boxplot(width=.1, alpha = 0.2, outlier.shape = NA) +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                     scales = "free_y") +
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle(paste0("Sex vs ", i, " (CD8)")) +
          ylab(i) + 
          scale_y_log10() +
          stat_compare_means(comparisons = my_comparisons,
                              size = 3.5)
  )
```


```{r sex_SRT, fig.dim = c(10, 8)}

# for(i in SRT)
#   print(
#     SRT_sex %>%
#       filter(!is.na(i)) %>%
#       filter(!is.na(Sex)) %>%
#       filter(Marker1 == "CD4") %>% 
#       as.data.frame() %>%
#       filter(!is.na(!!sym(i))) %>%
#         ggplot(aes(x = Sex, y = !!sym(i))) +
#           geom_point(alpha = 0.7) + 
#           geom_violin() + geom_jitter(width = 0.1, alpha = 0.5,
#                                       outlier.shape = NA,
#                                       aes(color = factor(Dexa))) + 
#           labs(col = "Dexa") +
#           scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#           geom_boxplot(width=.1, alpha = 0.2) +
#           theme_bw() + facet_wrap(~factor(Timepoint, 
#                                           levels = c('W 2', 'W3-6', 
#                                                      'M2-4', 'after month 5', 
#                                                      'post vacc')),
#                                   scales = "free_y") +
#           theme(strip.background =element_rect(fill="aliceblue")) +
#           ggtitle(paste0("Sex vs ", i, " (CD4)")) +
#           ylab(i) + 
#           scale_y_log10() +
#           stat_compare_means(comparisons = my_comparisons,
#                              size = 4)
#   )
# 
# for(i in SRT)
#   print(
#     SRT_sex %>%
#       filter(!is.na(i)) %>%
#       filter(!is.na(Sex)) %>%
#       filter(Marker1 == "CD8") %>% 
#       as.data.frame() %>%
#       filter(!is.na(!!sym(i))) %>%
#         ggplot(aes(x = Sex, y = !!sym(i))) +
#           geom_point(alpha = 0.7) + 
#           geom_violin() + geom_jitter(width = 0.1, alpha = 0.5,
#                                       outlier.shape = NA,
#                                       aes(color = factor(Dexa))) + 
#           labs(col = "Dexa") +
#           scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#           geom_boxplot(width=.1, alpha = 0.2) +
#           theme_bw() + facet_wrap(~factor(Timepoint, 
#                                           levels = c('W 2', 'W3-6', 
#                                                      'M2-4', 'after month 5', 
#                                                      'post vacc')),
#                                   scales = "free_y") +
#           ggtitle(paste0("Sex vs ", i, " (CD8)")) +
#           ylab(i) + 
#           scale_y_log10() +
#           stat_compare_means(comparisons = my_comparisons,
#                              size = 4)
#   )

```

## PNT vs disease severity

```{r severity_vs_serum_violin, fig.dim = c(10,8)}
breaks <- 10^(-10:10)
minor_breaks <- rep(1:9, 21)*(10^rep(-10:10, each=9))

PNT_Dexa_timepoint <- PNT %>% 
  select(PatID_Studie1, TagPSO, Days, B.1.1.7, B.1.617.2, Dexa) %>% 
  distinct() %>% 
  mutate(Timepoint = rep(0, nrow(.))) %>% 
  filter(!PatID_Studie1 == "183")

for(i in 1:nrow(PNT_Dexa_timepoint))
  #if(is.na(PNT_Dexa_timepoint$Timepoint[i]))
  {
    if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "d25-60"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "d39-60"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "d39-46"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "5-7mo"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "after month 5"
    } else if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "PostVac"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "post vacc"
    }else if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "2-4mo"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "M2-4"
    } else if(grepl(PNT_Dexa_timepoint$Days[i], pattern = "d80-140"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "M2-4"
    } else if(grepl(PNT_Dexa_timepoint$TagPSO[i], pattern = "6"))
      {
        PNT_Dexa_timepoint$Timepoint[i] <- "W 2"
    }
  }
cols <- c("1" = "orangered", "0" = "blue", "3" = "green3")
# B.1.1.7
level_order <- c('1', '0', '3')
PNT_Dexa_timepoint %>%
  #filter(Marker1 == "CD4") %>%
      as.data.frame() %>%
      ggplot(aes(x = factor(Dexa, level = level_order), y = B.1.1.7, colour = factor(Dexa))) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      # scale_fill_manual(breaks = c("1", "0", "3"),
      #                   values=c("orangered", "blue", "green3")) +
        geom_jitter() +
        geom_violin(alpha = 0.3) +
        labs(col = "Dexa") +
        geom_boxplot(width=.1) +
        stat_compare_means(method = "wilcox.test", 
                           comparisons = list(c("0", "3")), 
                     label.y = 4.5, size = 3) +
        stat_compare_means(method = "wilcox.test", 
                           comparisons = list(c("0", "1")), 
                     label.y = 4.7, size = 3) +
        stat_compare_means(method = "wilcox.test", 
                           comparisons = list(c("1", "3")), 
                     label.y = 5, size = 3) +
        #stat_compare_means(label.y = 5.5, size = 3) +
        scale_y_log10(breaks = breaks, minor_breaks = minor_breaks) +
        annotation_logticks(sides = "l")+
        theme_bw() + facet_wrap(~factor(Timepoint, 
                                        levels=c('W 2', 'W3-6', 'M2-4', 
                                                 'after month 5', 
                                                 'post vacc')),
                                scales = "free_y") +
        theme(strip.background =element_rect(fill="aliceblue")) +
        ggtitle("PNT vs severity") +
        xlab("Severity (dexa levels: 1(Dexa), 0(no Dexa), 3(mild))")+
        ylab("Serum ID50: B.1.1.7")

# B.1.617.2
PNT_Dexa_timepoint %>%
  #filter(Marker1 == "CD4") %>%
      as.data.frame() %>%
      ggplot(aes(x = B.1.617.2, y = factor(Dexa, level = level_order), colour = factor(Dexa))) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
        geom_jitter(width = 0.05) +
        geom_violin(width = 0.5) +
        labs(col = "Dexa") +
        geom_boxplot(width=.1) +
        stat_compare_means(method = "wilcox.test", 
                           comparisons = list(c("0", "3")), 
                     label.y = 4.5, size = 3) +
        stat_compare_means(method = "wilcox.test", 
                           comparisons = list(c("0", "1")), 
                     label.y = 4.7, size = 3) +
        stat_compare_means(method = "wilcox.test", 
                           comparisons = list(c("1", "3")), 
                     label.y = 5, size = 3) +
        scale_x_log10(breaks = breaks, minor_breaks = minor_breaks) +
        scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
        annotation_logticks(sides = "l")+
        theme_bw() + facet_wrap(~factor(Timepoint, 
                                        levels=c('W 2', 'W3-6', 
                                                 'M2-4', 'after month 5', 
                                                 'post vacc')),
                                scales = "free_x") +
        theme(strip.background =element_rect(fill="aliceblue")) +
        ggtitle("PNT vs severity") +
        ylab("Severity (dexa levels: 1(Dexa), 0(no Dexa), 3(mild))") +
        xlab("Serum ID50: B.1.617.2")+ 
        coord_flip()
```

## Age vs PNT

```{r age_vs_serum_violin}

PNT %>% 
  left_join(., meta) %>% 
  select(PatID_Studie1, Sex, Age, B.1.1.7, B.1.617.2, Days, Dexa) %>% 
  distinct() %>% 
  mutate(Timepoint = rep(0, nrow(.))) %>% 
  filter(!is.na(Sex)) -> PNT_Age_Sex

for(i in 1:nrow(PNT_Age_Sex))
  #if(is.na(PNT_Age_Sex$Timepoint[i]))
  {
    if(grepl(PNT_Age_Sex$Days[i], pattern = "d25-60"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "d39-60"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "d39-46"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "5-7mo"))
      {
        PNT_Age_Sex$Timepoint[i] <- "after month 5"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "PostVac"))
      {
        PNT_Age_Sex$Timepoint[i] <- "post vacc"
    }else if(grepl(PNT_Age_Sex$Days[i], pattern = "2-4mo"))
      {
        PNT_Age_Sex$Timepoint[i] <- "M2-4"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "d80-140"))
      {
        PNT_Age_Sex$Timepoint[i] <- "M2-4"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "6"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W 2"
    }
  }
# B.1.1.7
PNT_Age_Sex %>%
  as.data.frame() %>%
    ggplot(aes(x = Age, y = B.1.1.7)) +
      geom_point(alpha = 0.7, aes(color = factor(Dexa))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      theme_bw() + facet_wrap(.~factor(Timepoint, 
                                       levels = c('W3-6', 'M2-4', 
                                                  'after month 5', 
                                                  'post vacc'))) +
      theme(strip.background =element_rect(fill="aliceblue")) +
      ggtitle("PNT vs Age") +
      ylab("Serum ID50: B.1.1.7 levels") + 
      scale_y_log10() +
      stat_cor(method = "spearman", label.x = 0.2, label.y = 0.2, size = 3)


# B.1.617.2
PNT_Age_Sex %>%
  as.data.frame() %>%
  ggplot(aes(x = Age, y = B.1.617.2)) +
    geom_point(alpha = 0.7, aes(color = factor(Dexa))) + 
    labs(col = "Dexa") +
    scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
    theme_bw() + facet_wrap(.~factor(Timepoint, 
                                     levels = c('W3-6', 'M2-4', 
                                                'after month 5', 
                                                'post vacc'))) +
    theme(strip.background =element_rect(fill="aliceblue")) +
    ggtitle("PNT vs Age") +
    ylab("Serum ID50: B.1.617.2 levels") + 
    scale_y_log10() +
    stat_cor(method = "spearman", label.x = 0.2, label.y = 0.2, size = 3)


```


## Sex vs PNT

```{r, fig.dim = c(10,8)}
PNT %>% 
  left_join(., meta) %>% 
  select(PatID_Studie1, Sex, Age, B.1.1.7, B.1.617.2, Days, Dexa) %>% 
  distinct() %>% 
  mutate(Timepoint = rep(0, nrow(.))) %>% 
  filter(!is.na(Sex)) -> PNT_Age_Sex

for(i in 1:nrow(PNT_Age_Sex))
  #if(is.na(PNT_Age_Sex$Timepoint[i]))
  {
    if(grepl(PNT_Age_Sex$Days[i], pattern = "d25-60"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "d39-60"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "d39-46"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W3-6"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "5-7mo"))
      {
        PNT_Age_Sex$Timepoint[i] <- "after month 5"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "PostVac"))
      {
        PNT_Age_Sex$Timepoint[i] <- "post vacc"
    }else if(grepl(PNT_Age_Sex$Days[i], pattern = "2-4mo"))
      {
        PNT_Age_Sex$Timepoint[i] <- "M2-4"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "d80-140"))
      {
        PNT_Age_Sex$Timepoint[i] <- "M2-4"
    } else if(grepl(PNT_Age_Sex$Days[i], pattern = "6"))
      {
        PNT_Age_Sex$Timepoint[i] <- "W 2"
    }
  }

my_comparisons <- list(c("Männlich", "Weiblich"))
# B.1.1.7

PNT_Age_Sex %>%
  as.data.frame() %>%
      ggplot(aes(x = Sex, y = B.1.1.7)) +
        #geom_point(alpha = 0.7) + 
        geom_violin() + 
        geom_jitter(width = 0.1, aes(color = factor(Dexa))) + 
        labs(col = "Dexa") +
        scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
        geom_boxplot(width=.1, alpha = 0.2) +
        theme_bw() + facet_wrap(.~factor(Timepoint, 
                                         levels = c('W3-6', 'M2-4', 
                                                    'after month 5',
                                                    'post vacc'))) +
        theme(strip.background =element_rect(fill="aliceblue")) +
        ggtitle("Sex vs B.1.1.7") +
        ylab("Serum ID50: B.1.1.7 levels") + 
        scale_y_log10() +
        stat_compare_means(comparisons = my_comparisons,
                           size = 3.5)

# B.1.617.2
PNT_Age_Sex %>%
  as.data.frame() %>%
      ggplot(aes(x = Sex, y = B.1.617.2)) +
        #geom_point(alpha = 0.7) + 
        geom_violin() + 
        geom_jitter(width = 0.1, aes(color = factor(Dexa))) + 
        labs(col = "Dexa") +
        scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
        geom_boxplot(width=.1, alpha = 0.2) +
        theme_bw() + facet_wrap(.~factor(Timepoint, 
                                         levels = c('W3-6', 'M2-4', 
                                                    'after month 5', 
                                                    'post vacc'))) +
        theme(strip.background =element_rect(fill="aliceblue")) +
        ggtitle("Sex vs B.1.1.7") +
        ylab("Serum ID50: B.1.1.7 levels") + 
        scale_y_log10() +
        stat_compare_means(comparisons = my_comparisons,
                           label.y = 4.5, size = 3.5)


```



## Correlation of IgG levels vs PNT

```{r serology, fig.dim = c(10,8)}

# Cor IgG vs PNT at different timepoints
Sero_PNT <- sero %>% 
  left_join(., PNT, by = "PatID_Studie1") %>%
  select(PatID_Studie1, Timepoint, Days, Dexa.x, B.1.1.7, B.1.617.2, IgG) %>%
  na.omit()
  

time <- data.frame(time = c("M2-4", "M2-4", "after month 5", 
                            "post vacc", "W 2"),
                   days = c("2-4mo", "d80-140", "5-7mo", "PostVac", "NA"))

# get IgG measurements and PNT for the same time points
a = 1
sero_PNT_cor <- data.frame()

for(i in 1:nrow(Sero_PNT))
{
  index_tp <- grep(pattern = Sero_PNT$Timepoint[i], time$time)
  index_dy <- grep(pattern = Sero_PNT$Days[i], time$days)
  if(any(index_tp == index_dy))
  {
    sero_PNT_cor[a,1:7] <- Sero_PNT[i,]
    a = a+1
  }
}

# IgG vs B.1.1.7

sero_PNT_cor %>% 
  ggplot(aes(x = B.1.1.7, y = IgG)) +
  geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Timepoint, levels = c('M2-4', 'after month 5', 
                                           'post vacc')), 
             scales = "free_y") +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs PNT measures at the same time point") +
  xlab("B.1.1.7") + ylab("IgG BAU/ml") +
  stat_cor(method = "spearman", size = 3) +
  geom_smooth(method = "lm", se = F)

sero_PNT_cor %>% 
  ggplot(aes(x = B.1.1.7, y = IgG, colour = factor(Dexa.x))) +
  geom_point(alpha = 0.7) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Timepoint, levels = c('M2-4', 'after month 5', 
                                           'post vacc')), 
             scales = "free_y") +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs PNT measures at the same time point") +
  xlab("B.1.1.7") + ylab("IgG BAU/ml") +
  stat_cor(method = "spearman", label.x = 2500, size = 3) +
  geom_smooth(method = "lm", se = F)

# IgG vs B.1.617.2

sero_PNT_cor %>% 
  ggplot(aes(x = B.1.617.2, y = IgG)) +
  geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Timepoint, levels = c('M2-4', 'after month 5', 
                                           'post vacc')), 
             scales = "free_y") +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs PNT measures at the same time point") +
  xlab("B.1.617.2") + ylab("IgG BAU/ml") +
  stat_cor(method = "spearman", label.x = 2500, size = 3) +
  geom_smooth(method = "lm", se = F)

sero_PNT_cor %>% 
  ggplot(aes(x = B.1.617.2, y = IgG, colour = factor(Dexa.x))) +
  geom_point(alpha = 0.7) +
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                     values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Timepoint, levels = c('M2-4', 'after month 5', 
                                           'post vacc')),
             scales = "free_y") +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  ggtitle("IgG vs PNT measures at the same time point") +
  xlab("B.1.617.2") + ylab("IgG BAU/ml") +
  stat_cor(method = "spearman", label.x = 2500, size = 3) +
  geom_smooth(method = "lm", se = F)


```

## Correlation of IgG vs SRT

```{r sero_SRT, fig.dim=c(10,8)}

# Cor IgG vs PNT at different timepoints
Sero_SRT <- sero %>% 
  left_join(., facs, by = c("PatID_Studie1", "Timepoint", "Dexa")) %>%
  select(PatID_Studie1, Dexa, Timepoint, 
         Marker1, Marker2, S1, S2, CEFX, SEB, IgG) %>% 
  mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2"))

# IgG vs SRT
for(i in SRT)
  print(
    Sero_SRT %>% 
      filter(Marker1=="CD4") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) +
      geom_point(alpha = 0.7, aes(color = factor(Dexa))) +
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      ggtitle("IgG vs SRT (CD4)") +
      xlab("IgG BAU/ml") +
      stat_cor(method = "spearman", size = 3.5) +
      geom_smooth(method = "lm", se = F)
  )

# for(i in SRT)
#   print(
#     Sero_SRT %>% 
#       filter(Marker1=="CD4") %>% 
#       ggplot(aes(x = IgG, y = !!sym(i), colour = factor(Dexa))) +
#       geom_point(alpha = 0.7) +
#       labs(col = "Dexa") +
#       scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#       facet_grid(~factor(Timepoint, levels = c("W 2", "M2-4", 
#                                                "after month 5")),
#                  scales = "free_y") +
#       theme_bw() +
#       theme(strip.background =element_rect(fill="aliceblue")) +
#       ggtitle("IgG vs SRT (CD4)") +
#       xlab("IgG BAU/ml") +
#       stat_cor(method = "spearman", label.x = 1000, size = 2.5) +
#       geom_smooth(method = "lm", se = F)
#   )

# CD8
for(i in SRT)
  print(
    Sero_SRT %>% 
      filter(Marker1=="CD8") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) +
      geom_point(alpha = 0.7, aes(color = factor(Dexa))) +
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      ggtitle("IgG vs SRT (CD8)") +
      xlab("IgG BAU/ml") +
      stat_cor(method = "spearman", size = 3.5) +
      geom_smooth(method = "lm", se = F)
  )

# for(i in SRT)
#   print(
#     Sero_SRT %>% 
#       filter(Marker1=="CD8") %>% 
#       ggplot(aes(x = IgG, y = !!sym(i), colour = factor(Dexa))) +
#       geom_point(alpha = 0.7) +
#       labs(col = "Dexa") +
#       scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#       facet_grid(~factor(Timepoint, levels = c("W 2", "M2-4", 
#                                                "after month 5")),
#                  scales = "free_y") +
#       theme_bw() +
#       xlab("IgG BAU/ml") +
#       stat_cor(method = "spearman", label.x = 1000, size = 2.5) +
#       geom_smooth(method = "lm", se = F)
#   )

```

## Correlation of PNT vs SRT
```{r SRT_vs_PNT, results = 'hide', fig.show = 'all', fig.dim=c(10,8)}
# all dexa levels

strain <- c("B.1.1.7", "B.1.617.2")
SRT <- c("S1", "S2", "CEFX", "SEB")

PNT %>% 
  left_join(., facs) %>% 
  select(PatID_Studie1, Dexa, Timepoint, S1, S2, CEFX, SEB, 
  B.1.1.7, B.1.617.2, Marker1, Marker2) %>% 
  mutate(Timepoint = str_replace(Timepoint, "1", "post vacc")) -> PNT_SRT

for(i in SRT)
  for(j in strain)
    print(PNT_SRT %>%
      filter(Marker1 == "CD4") %>%
      as.data.frame() %>%
      ggplot(., aes_string(x = j, y = i)) +
        geom_point(alpha = 0.7, aes(color = factor(Dexa))) +
        labs(col = "Dexa") +
        scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
        theme_bw() + 
        facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                   scales = "free") +
        theme(strip.background =element_rect(fill="aliceblue")) +
        ggtitle("PNT vs SRT correlation: CD4 cells") +
        stat_cor(method = "spearman", size = 4))


for(i in SRT)
  for(j in strain)
    print(PNT_SRT %>%
      filter(Marker1 == "CD8") %>%
      as.data.frame() %>%
      ggplot(., aes_string(x = j, y = i)) +
        geom_point(alpha = 0.7, aes(color = factor(Dexa))) +
        labs(col = "Dexa") +
        scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
        theme_bw() + 
        facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                   scales = "free") +
        theme(strip.background =element_rect(fill="aliceblue")) +
        ggtitle("PNT vs SRT correlation: CD8 cells") +
        stat_cor(method = "spearman", size = 4))
```


## Time series

### Progression of S1, S2, CEFX and SEB
```{r progression,tidy=TRUE, tidy.opts=list(width.cutoff=60)}

SRT <- c("S1", "S2")

facs %>% 
  mutate(Timepoint = str_replace(Timepoint, "1", "post vacc")) -> facs_prog

# for(i in SRT)
#   print(
#     facs_prog %>%
#       filter(Marker1 == "CD4") %>%
#       filter(!Timepoint == "post vacc") %>% 
#     ggplot(., aes(x = factor(Timepoint, 
#                              levels = c('W 2', 'W3-6', 'M2-4', 
#                                         'after month 5')), 
#                   y = !!sym(i), 
#                   colour = factor(Dexa))) +
#       theme(axis.text.x = element_text(angle = 90)) +
#       geom_jitter(width = 0.1, alpha = 0.2) +
#       scale_y_log10() +
#       labs(col = "Dexa") + 
#       #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
#       #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
#       scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#       scale_fill_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#       facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
#                                              "CD40L+ IFN-g+","CD40L+ IL-21+",
#                                              "CD40L+ TNF-a+","CD137+ GrzB+",
#                                              "CD137+ IFN-g+","CD137+ IL-21+",
#                                              "CD137+ TNF-a+","CD137+ GrzB-")),
#                  scales = "free", ncol = 2) +
#       geom_smooth(method = "loess", aes(group = factor(Dexa)), alpha = 0.7, 
#                   se = F, size = 0.4) +
#       xlab("Time point") +
#       ggtitle(paste0(i, " progression in CD4 cells")) +
#       theme_bw() +
#       theme(strip.background =element_rect(fill="aliceblue")))
# 
# for(i in SRT)
#   print(
#     facs_prog %>%
#       filter(Marker1 == "CD4") %>%
#       filter(!Timepoint == "post vacc") %>% 
#     ggplot(aes(x = TagPSO, y = !!sym(i), 
#                   colour = factor(Dexa))) +
#       geom_point(alpha = 0.3) +
#       labs(col = "Dexa") +
#       scale_y_log10() +
#       scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#       facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
#                                              "CD40L+ IFN-g+","CD40L+ IL-21+",
#                                              "CD40L+ TNF-a+","CD137+ GrzB+",
#                                              "CD137+ IFN-g+","CD137+ IL-21+",
#                                              "CD137+ TNF-a+","CD137+ GrzB-")),
#                  scales = "free", ncol = 2) +
#       theme(strip.background =element_rect(fill="aliceblue")) +
#       geom_smooth(method = "loess", aes(group = factor(Dexa)), alpha = 0.7, 
#                   se = F, size = 0.4) +
#       xlab("Days PSO") +
#       ggtitle(paste0(i, " progression in CD4 cells")) +
#       theme(axis.text.x = element_text(angle = 90)) +
#       theme_bw() +
#       theme(strip.background =element_rect(fill="aliceblue")))


# select patients with at least two time points

SRT_2_tp <- facs_pat_3timepoints %>% 
  filter(number_of_FACS_timepoints >= 2)

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD4") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD40L+ CD137+" | Marker2 ==  "CD40L+ IFN-g+" | Marker2 == "CD40L+ IL-21+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+")),
                 scales = "free", ncol = 3) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Time point") +
      ggtitle(paste0(i, " progression in CD4 cells")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD4") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD40L+ CD137+" | Marker2 ==  "CD40L+ IFN-g+" | Marker2 == "CD40L+ IL-21+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(aes(x = TagPSO, y = !!sym(i), 
                  colour = factor(Dexa))) +
      geom_point(alpha = 0.3) +
      labs(col = "Dexa") +
      scale_y_log10() +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+")),
                 scales = "free", ncol = 3) +
      theme(strip.background =element_rect(fill="aliceblue")) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Days PSO") +
      ggtitle(paste0(i, " progression in CD4 cells")) +
      theme(axis.text.x = element_text(angle = 90)) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD4") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD40L+ CD137+" | Marker2 ==  "CD40L+ IFN-g+" | Marker2 == "CD40L+ IL-21+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa),
                  group = factor(PatID_Studie1))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_point(position = position_dodge(0.4), alpha = 0.5) +
      #geom_jitter(width = 0.1, alpha = 0.2, position = position_dodge(0.4)) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+")),
                 scales = "free", ncol = 3) +
      geom_line(position = position_dodge(0.4), aes(group = factor(PatID_Studie1)), 
                alpha = 0.8, size = 0.2)+
      xlab("Time point") +
      ggtitle(paste0(i, " grouped by patient ID")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))
```

```{r fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
### separating by dexa

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD4") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD40L+ CD137+" | Marker2 ==  "CD40L+ IFN-g+" | Marker2 == "CD40L+ IL-21+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(factor(Marker2, levels = c("CD40L+ CD137+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+")) ~ factor(Dexa, levels = c('1', '0', '3')),
                 ncol = 3) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Time point") +
      ggtitle(paste0(i, " progression in CD4 cells")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD4") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD40L+ CD137+" | Marker2 ==  "CD40L+ IFN-g+" | Marker2 == "CD40L+ IL-21+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa),
                  group = factor(PatID_Studie1))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_point(position = position_dodge(0.4), alpha = 0.5) +
      #geom_jitter(width = 0.1, alpha = 0.2, position = position_dodge(0.4)) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(factor(Marker2, levels = c("CD40L+ CD137+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+")) ~ factor(Dexa, levels = c('1', '0', '3')),
                 ncol = 3) +
      geom_line(position = position_dodge(0.4), aes(group = factor(PatID_Studie1)), 
                alpha = 0.8, size = 0.2)+
      xlab("Time point") +
      ggtitle(paste0(i, " CD4 grouped by patient ID")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))
```



```{r}
# CD8+

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD8") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD137+ TNF-a+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD137+ TNF-a+")),
                 scales = "free", ncol = 3) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Time point") +
      ggtitle(paste0(i, " progression in CD8 cells")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD8") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD137+ TNF-a+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(aes(x = TagPSO, y = !!sym(i), 
                  colour = factor(Dexa))) +
      geom_point(alpha = 0.3) +
      labs(col = "Dexa") +
      scale_y_log10() +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD137+ TNF-a+")),
                 scales = "free", ncol = 3) +
      theme(strip.background =element_rect(fill="aliceblue")) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Days PSO") +
      ggtitle(paste0(i, " progression in CD8 cells")) +
      theme(axis.text.x = element_text(angle = 90)) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD8") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD137+ TNF-a+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa),
                  group = factor(PatID_Studie1))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_point(position = position_dodge(0.4), alpha = 0.5) +
      #geom_jitter(width = 0.1, alpha = 0.2, position = position_dodge(0.4)) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD137+ TNF-a+")),
                 scales = "free", ncol = 3) +
      geom_line(position = position_dodge(0.4), aes(group = factor(PatID_Studie1)), 
                alpha = 0.8, size = 0.2)+
      xlab("Time point") +
      ggtitle(paste0(i, " CD8 grouped by patient ID")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

# sep by dexa
for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD8") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD137+ TNF-a+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa),
                  group = factor(PatID_Studie1))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_point(position = position_dodge(0.4), alpha = 0.5) +
      #geom_jitter(width = 0.1, alpha = 0.2, position = position_dodge(0.4)) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(factor(Marker2, levels = c("CD137+ TNF-a+")) ~ factor(Dexa, levels = c('1', '0', '3')),
                 ncol = 3) +
      geom_line(position = position_dodge(0.4), aes(group = factor(PatID_Studie1)), 
                alpha = 0.8, size = 0.2)+
      xlab("Time point") +
      ggtitle(paste0(i, " progression in CD8 cells")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in SRT)
  print(
    facs_prog %>%
      filter(Marker1 == "CD8") %>%
      filter(!Timepoint == "post vacc") %>% 
      filter(Marker2 == "CD137+ TNF-a+") %>% 
      left_join(SRT_2_tp, ., by = "PatID_Studie1") %>% 
    ggplot(., aes(x = factor(Timepoint, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa),
                  group = factor(PatID_Studie1))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_point(position = position_dodge(0.4), alpha = 0.5) +
      #geom_jitter(width = 0.1, alpha = 0.2, position = position_dodge(0.4)) +
      scale_y_log10() +
      labs(col = "Dexa") + 
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(factor(Marker2, levels = c("CD137+ TNF-a+")) ~ factor(Dexa, levels = c('1', '0', '3')),
                 ncol = 3) +
      geom_line(position = position_dodge(0.4), aes(group = factor(PatID_Studie1)), 
                alpha = 0.8, size = 0.2)+
      xlab("Time point") +
      ggtitle(paste0(i, " CD8 grouped by patient ID")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))


```

### Progression of PNT
```{r PNTprogression}

PNT %>% 
  left_join(., facs) %>% 
  select(PatID_Studie1, Dexa, TagPSO,
         Days, B.1.1.7, B.1.617.2) %>% 
  distinct() %>% 
  add_column(PNT_time = NA)-> PNT_progression



for(i in 1:nrow(PNT_progression))
  #if(!is.na(PNT_progression$SRT_time[i]))
  {
    if(grepl(PNT_progression$Days[i], pattern = "d25-60"))
      {
        PNT_progression$PNT_time[i] <- "W3-6"
    } else if(grepl(PNT_progression$Days[i], pattern = "d39-60"))
      {
        PNT_progression$PNT_time[i] <- "W3-6"
    } else if(grepl(PNT_progression$Days[i], pattern = "d39-46"))
      {
        PNT_progression$PNT_time[i] <- "W3-6"
    } else if(grepl(PNT_progression$Days[i], pattern = "5-7mo"))
      {
        PNT_progression$PNT_time[i] <- "after month 5"
    } else if(grepl(PNT_progression$Days[i], pattern = "PostVac"))
      {
        PNT_progression$PNT_time[i] <- "post vacc"
    }else if(grepl(PNT_progression$Days[i], pattern = "2-4mo"))
      {
        PNT_progression$PNT_time[i] <- "M2-4"
    } else if(grepl(PNT_progression$Days[i], pattern = "d80-140"))
      {
        PNT_progression$PNT_time[i] <- "M2-4"
     } #else if(grepl(PNT_progression$TagPSO.x[i], pattern = "6"))
    #   {
    #     PNT_progression$PNT_time[i] <- "W 2"
    # }
  }

## only pick the patients that have at least two time points
PNT_2_tp <- PNT_pat_3timepoints %>% 
  filter(number_of_PNT_timepoints >= 2)

for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      ggplot(., aes(x = factor(PNT_time, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      labs(col = "Dexa") +
      scale_y_log10() +
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
      #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
      #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
      #                                        "CD137+ IFN-g+","CD137+ IL-21+",
      #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
      #            scales = "free") +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Timepoint") +
      ggtitle(paste0(i, " progression")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      ggplot(., aes(x = TagPSO, y = !!sym(i), colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      labs(col = "Dexa") +
      scale_y_log10() +
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
      #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
      #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
      #                                        "CD137+ IFN-g+","CD137+ IL-21+",
      #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
      #            scales = "free") +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Days PSO") +
      ggtitle(paste0(i, " progression")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))
## Days PSO for post vacc was NA, and didn't get plotted

for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      filter(!PatID_Studie1 == "435") %>%
      ggplot(aes(x = factor(PNT_time, 
                               levels = c('W 2', 'W3-6', 'M2-4', 
                                          'after month 5')), 
                 y = !!sym(i), 
                 colour = factor(Dexa),
                 group = factor(PatID_Studie1))) +
        labs(col = "Dexa") +
        theme(axis.text.x = element_text(angle = 90)) +
        #geom_jitter(width = 0.1, alpha = 0.2) +
        geom_point(position = position_dodge(0.4), alpha = 0.5) +
        scale_y_log10() +
        #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
        #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
        scale_color_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        scale_fill_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
        #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
        #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
        #                                        "CD137+ IFN-g+","CD137+ IL-21+",
        #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
        #            scales = "free") +
        geom_line(position = position_dodge(0.4), 
                  aes(group = factor(PatID_Studie1)), alpha = 0.8, 
                  size = 0.2) +
        xlab("Timepoint") +
        ggtitle("PNT progression (by patient ID)") +
        theme_bw() +
        #theme(legend.position = "none") +
        theme(strip.background =element_rect(fill="aliceblue")))


for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      filter(!PatID_Studie1 == "435") %>%
      ggplot(aes(x = as.numeric(TagPSO), 
                 y = !!sym(i), 
                 colour = factor(Dexa),
                 group = factor(PatID_Studie1))) +
        theme(axis.text.x = element_text(angle = 90)) +
        #geom_jitter(width = 0.1, alpha = 0.2) +
        geom_point(alpha = 0.5) +
        labs(col = "Dexa") +
        scale_y_log10() +
        #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
        #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
        scale_color_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        scale_fill_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
        #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
        #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
        #                                        "CD137+ IFN-g+","CD137+ IL-21+",
        #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
        #            scales = "free") +
        geom_line(#position = position_dodge(0.4), 
                  aes(group = factor(PatID_Studie1)), alpha = 0.8, 
                  size = 0.2) +
        xlab("Days PSO") +
        ggtitle("PNT progression (by patient ID)") +
        theme_bw() +
        #theme(legend.position = "none") +
        theme(strip.background =element_rect(fill="aliceblue")))

## sep by dexa

for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      ggplot(., aes(x = factor(PNT_time, 
                             levels = c('W 2', 'W3-6', 'M2-4', 
                                        'after month 5')), 
                  y = !!sym(i), 
                  colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      labs(col = "Dexa") +
      scale_y_log10() +
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
      #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
      #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
      #                                        "CD137+ IFN-g+","CD137+ IL-21+",
      #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
      #            scales = "free") +
      facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Timepoint") +
      ggtitle(paste0(i, " progression")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))

for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      ggplot(., aes(x = TagPSO, y = !!sym(i), colour = factor(Dexa))) +
      theme(axis.text.x = element_text(angle = 90)) +
      geom_jitter(width = 0.1, alpha = 0.2) +
      labs(col = "Dexa") +
      scale_y_log10() +
      #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
      #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      scale_fill_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
      #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
      #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
      #                                        "CD137+ IFN-g+","CD137+ IL-21+",
      #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
      #            scales = "free") +
      facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
      geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                  se = F, size = 0.4) +
      xlab("Days PSO") +
      ggtitle(paste0(i, " progression")) +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")))
## Days PSO for post vacc was NA, and didn't get plotted

for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      filter(!PatID_Studie1 == "435") %>%
      ggplot(aes(x = factor(PNT_time, 
                               levels = c('W 2', 'W3-6', 'M2-4', 
                                          'after month 5')), 
                 y = !!sym(i), 
                 colour = factor(Dexa),
                 group = factor(PatID_Studie1))) +
        labs(col = "Dexa") +
        theme(axis.text.x = element_text(angle = 90)) +
        #geom_jitter(width = 0.1, alpha = 0.2) +
        geom_point(position = position_dodge(0.4), alpha = 0.5) +
        scale_y_log10() +
        #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
        #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
        scale_color_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        scale_fill_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
        #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
        #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
        #                                        "CD137+ IFN-g+","CD137+ IL-21+",
        #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
        #            scales = "free") +
      facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
        geom_line(position = position_dodge(0.4), 
                  aes(group = factor(PatID_Studie1)), alpha = 0.8, 
                  size = 0.2) +
        xlab("Timepoint") +
        ggtitle("PNT progression (by patient ID)") +
        theme_bw() +
        #theme(legend.position = "none") +
        theme(strip.background =element_rect(fill="aliceblue")))


for(i in strain)
  print(
    PNT_progression %>%
      filter(!PNT_time == "post vacc") %>% 
      left_join(PNT_2_tp, ., by = "PatID_Studie1") %>% 
      filter(!PatID_Studie1 == "435") %>%
      ggplot(aes(x = as.numeric(TagPSO), 
                 y = !!sym(i), 
                 colour = factor(Dexa),
                 group = factor(PatID_Studie1))) +
        theme(axis.text.x = element_text(angle = 90)) +
        #geom_jitter(width = 0.1, alpha = 0.2) +
        geom_point(alpha = 0.5) +
        labs(col = "Dexa") +
        scale_y_log10() +
        #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
        #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
        scale_color_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        scale_fill_manual(breaks = c("1", "0", "3"),
                          values=c("orangered", "blue", "green3")) +
        # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
        #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
        #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
        #                                        "CD137+ IFN-g+","CD137+ IL-21+",
        #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
        #            scales = "free") +
      facet_wrap(~factor(Dexa, levels = c('1', '0', '3'))) +
        geom_line(#position = position_dodge(0.4), 
                  aes(group = factor(PatID_Studie1)), alpha = 0.8, 
                  size = 0.2) +
        xlab("Days PSO") +
        ggtitle("PNT progression (by patient ID)") +
        theme_bw() +
        #theme(legend.position = "none") +
        theme(strip.background =element_rect(fill="aliceblue")))
```

### Progression of IgG

```{r IgGprogression}

sero %>%
  filter(!PatID_Studie1 == "435") %>% 
  filter(!Timepoint == "post vacc") %>% 
  ggplot(., aes(x = factor(Timepoint, 
                           levels = c('W 2', 'W3-6', 'M2-4', 
                                      'after month 5')), 
                y = IgG, 
                colour = factor(Dexa))) +
    theme(axis.text.x = element_text(angle = 90)) +
    geom_jitter(width = 0.1, alpha = 0.2) +
    labs(col = "Dexa") +
    scale_y_log10() +
    #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
    #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
    scale_color_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    scale_fill_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
    #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
    #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
    #                                        "CD137+ IFN-g+","CD137+ IL-21+",
    #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
    #            scales = "free") +
    geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                se = F, size = 0.4) +
    xlab("Timepoint") +
    ggtitle("IgG progression") +
    theme_bw() +
    theme(strip.background =element_rect(fill="aliceblue"))


sero %>%
  filter(!PatID_Studie1 == "435") %>% 
  filter(!Timepoint == "post vacc") %>% 
  ggplot(aes(x = as.numeric(TagPSO), 
                y = IgG, 
                colour = factor(Dexa))) +
    theme(axis.text.x = element_text(angle = 90)) +
    geom_jitter(width = 0.1, alpha = 0.2) +
    labs(col = "Dexa") +
    scale_y_log10() +
    #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
    #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
    scale_color_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    scale_fill_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
    #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
    #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
    #                                        "CD137+ IFN-g+","CD137+ IL-21+",
    #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
    #            scales = "free") +
    geom_smooth(method = "lm", aes(group = factor(Dexa)), alpha = 0.7, 
                se = F, size = 0.4) +
    xlab("Days PSO") +
    ggtitle("IgG progression") +
    theme_bw() +
    theme(strip.background =element_rect(fill="aliceblue"))

sero %>%
  filter(!PatID_Studie1 == "435") %>% 
  filter(!Timepoint == "post vacc") %>% 
  ggplot(aes(x = factor(Timepoint, 
                           levels = c('W 2', 'W3-6', 'M2-4', 
                                      'after month 5')), 
             y = IgG, 
             colour = factor(Dexa),
             group = factor(PatID_Studie1))) +
    theme(axis.text.x = element_text(angle = 90)) +
    #geom_jitter(width = 0.1, alpha = 0.2) +
    geom_point(position = position_dodge(0.4), alpha = 0.5) +
    labs(col = "Dexa") +
    scale_y_log10() +
    #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
    #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
    scale_color_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    scale_fill_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
    #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
    #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
    #                                        "CD137+ IFN-g+","CD137+ IL-21+",
    #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
    #            scales = "free") +
    geom_line(position = position_dodge(0.4), aes(group = factor(PatID_Studie1)), alpha = 0.8, 
              size = 0.2) +
    xlab("Timepoint") +
    ggtitle("IgG progression (by patient ID)") +
    theme_bw() +
    #theme(legend.position = "none") +
    theme(strip.background =element_rect(fill="aliceblue"))


sero %>%
  filter(!PatID_Studie1 == "435") %>% 
  filter(!Timepoint == "post vacc") %>% 
  ggplot(aes(x = as.numeric(TagPSO), 
             y = IgG, 
             colour = factor(Dexa),
             group = factor(PatID_Studie1))) +
    theme(axis.text.x = element_text(angle = 90)) +
    #geom_jitter(width = 0.1, alpha = 0.2) +
    geom_point(alpha = 0.5) +
    labs(col = "Dexa") +
    scale_y_log10() +
    #geom_boxplot(aes(fill = factor(Dexa)), width = 0.5, 
    #             colour = "gray47", alpha = 0.5, outlier.shape = NA) +
    scale_color_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    scale_fill_manual(breaks = c("1", "0", "3"),
                      values=c("orangered", "blue", "green3")) +
    # facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
    #                                        "CD40L+ IFN-g+","CD40L+ IL-21+",
    #                                        "CD40L+ TNF-a+","CD137+ GrzB+",
    #                                        "CD137+ IFN-g+","CD137+ IL-21+",
    #                                        "CD137+ TNF-a+","CD137+ GrzB-")),
    #            scales = "free") +
    geom_line(#position = position_dodge(0.4), 
              aes(group = factor(PatID_Studie1)), alpha = 0.8, 
              size = 0.2) +
    xlab("Days PSO") +
    ggtitle("IgG progression (by patient ID)") +
    theme_bw() +
    #theme(legend.position = "none") +
    theme(strip.background =element_rect(fill="aliceblue"))
```



## Correlation of early SRT vs late PNT

```{r early_SRT vs late_PNT}

PNT_SRT_diff_timepoints <- PNT %>% 
  left_join(., facs, by = "PatID_Studie1") %>% 
  group_by(PatID_Studie1) %>% 
  rename(SRT_time = Timepoint) %>% 
  add_column(PNT_time = NA)

for(i in 1:nrow(PNT_SRT_diff_timepoints))
  if(!is.na(PNT_SRT_diff_timepoints$SRT_time[i]))
  {
    if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "d25-60"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "W3-6"
    } else if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "d39-60"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "W3-6"
    } else if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "d39-46"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "W3-6"
    } else if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "5-7mo"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "after month 5"
    } else if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "PostVac"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "post vacc"
    }else if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "2-4mo"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "M2-4"
    } else if(grepl(PNT_SRT_diff_timepoints$Days[i], pattern = "d80-140"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "M2-4"
    } else if(grepl(PNT_SRT_diff_timepoints$TagPSO.x[i], pattern = "6"))
      {
        PNT_SRT_diff_timepoints$PNT_time[i] <- "W 2"
    }
  }
```

### Correlation SRT at W2, PNT at M2-4

```{r SRT at W2, PNT at M2-4, fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT at W2, PNT at M2-4
# B.1.1.7
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) at M2-4") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD4 early SRT vs later PNT (18 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 3) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) at M2-4") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD8 early SRT vs later PNT (18 patients)")
  )
# B.1.617.2
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) at M2-4") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD4 early SRT vs later PNT (18 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) at M2-4") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD8 early SRT vs later PNT (18 patients)")
  )
```

### Correlation SRT at W2, PNT at after month 5

```{r SRT at W2, PNT at after month 5, fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT at W2, PNT at after month 5
# B.1.1.7
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) after month 5") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD4 early SRT vs later PNT (10 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) after month 5") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD8 early SRT vs later PNT (10 patients)")
  )

# B.1.617.2
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) after month 5") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD4 early SRT vs later PNT (10 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W 2") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) after month 5") +
      ylab(paste0(i, " at W 2")) +
      ggtitle("CD8 early SRT vs later PNT (10 patients)")
  )
```

### Correlation SRT at W3, PNT at M2

```{r SRT at W3, PNT at M2, fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT at W3, PNT at M2
# B.1.1.7
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) at M2-4") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD4 early SRT vs later PNT (15 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) at M2-4") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD8 early SRT vs later PNT (15 patients)")
  )

# B.1.617.2
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.617.2) at M2-4") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD4 early SRT vs later PNT (15 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "M2-4", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.617.2) at M2-4") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD8 early SRT vs later PNT (15 patients)")
  )
```

### Correlation SRT at W3, PNT after month 5

```{r SRT at W3, PNT after month 5, fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT at W3, PNT after month 5
# B.1.1.7
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) after month 5") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD4 early SRT vs later PNT (7 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.1.7, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.1.7) after month 5") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD8 early SRT vs later PNT (7 patients)")
  )

# B.1.617.2
for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.617.2) after month 5") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD4 early SRT vs later PNT (7 patients)")
  )

for(i in SRT)
  print(
    PNT_SRT_diff_timepoints %>% 
      filter(PNT_time == "after month 5", SRT_time == "W3-6") %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = B.1.617.2, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("PNT (B.1.617.2) after month 5") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD8 early SRT vs later PNT (7 patients)")
  )
```




\newpage



## Correlation of early SRT vs late IgG

```{r late_IgG_vs_early_SRT}

sero_SRT_diff_timepoints <- sero %>% 
  left_join(., facs, by = "PatID_Studie1") %>% 
  group_by(PatID_Studie1) %>% 
  select(PatID_Studie1, Timepoint.x, Timepoint.y, Dexa.x) %>% 
  rename(Sero_time = Timepoint.x, SRT_time = Timepoint.y) %>% 
  distinct()

SRT_W2_sero_M2 <- sero_SRT_diff_timepoints %>% 
  filter(Sero_time == "M2-4", SRT_time == "W 2")

SRT_W3_sero_M5 <- sero_SRT_diff_timepoints %>% 
  filter(Sero_time == "after month 5", SRT_time == "W3-6")

SRT_W2_sero_M5 <- sero_SRT_diff_timepoints %>% 
  filter(Sero_time == "after month 5", SRT_time == "W 2")

SRT_W3_sero_M2 <- sero_SRT_diff_timepoints %>% 
  filter(Sero_time == "M2-4", SRT_time == "W3-6")
```

### Correlation of SRT @ W2 vs IgG @ M2-4
```{r SRT W2 vs IgG M2-4_1, fig.height = 15, fig.width = 10,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT W2 vs IgG M2-4
SRT_W2_sero_M2_pat <- sero %>% 
  left_join(., facs, by = "PatID_Studie1") %>% 
  group_by(PatID_Studie1) %>% 
  rename(Sero_time = Timepoint.x, SRT_time = Timepoint.y) %>% 
  filter(Sero_time == "M2-4", SRT_time == "W 2")

for(i in SRT)
  print(
    SRT_W2_sero_M2_pat %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) +
      labs(col = "Dexa") +

      #scale_y_log10() +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG at M2-4") +
      ylab(paste0(i, " at W2")) +
      ggtitle("CD4 early SRT vs later IgG (19 patients)")
  )
```

Of special interest:
```{r SRT W2 vs IgG M2-4_special}

SRT_W2_sero_M2_pat %>% 
  filter(Marker1 == "CD4" & Marker2 == "CD40L+ IL-21+") %>% 
  ggplot(aes(x = IgG, y = S1)) + 
  geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
  labs(col = "Dexa") +
  scale_color_manual(breaks = c("1", "0", "3"),
                    values=c("orangered", "blue", "green3")) +
  facet_wrap(~factor(Marker2, levels = c("CD40L+ IL-21+")),
             scales = "free_y") +
  stat_cor(method = "spearman", size = 4) +
  #stat_smooth(method = "lm", se = "F") +
  theme_bw() +
  theme(strip.background =element_rect(fill="aliceblue")) +
  xlab("IgG at M2-4") +
  ylab("S1 at W2") +
  ggtitle("CD4 (CD40L+ IL-21+) S1 at W2 vs IgG at M2-4 (19 patients)")
```

```{r SRT W2 vs IgG M2-4, fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}  
for(i in SRT)
  print(
    SRT_W2_sero_M2_pat %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG at M2-4") +
      ylab(paste0(i, " at W2")) +
      ggtitle("CD8 early SRT vs later IgG (19 patients)")
  )
```

### Correlation of SRT @ W2 vs IgG after month 5

```{r SRT W2 vs IgG after month 5, fig.height = 15, fig.width = 10, tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT W2 vs IgG after month 5
SRT_W2_sero_M5_pat <- sero %>% 
  left_join(., facs, by = "PatID_Studie1") %>% 
  group_by(PatID_Studie1) %>% 
  rename(Sero_time = Timepoint.x, SRT_time = Timepoint.y) %>% 
  filter(Sero_time == "after month 5", SRT_time == "W 2")

for(i in SRT)
  print(
    SRT_W2_sero_M5_pat %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG after month 5") +
      ylab(paste0(i, " at W2")) +
      ggtitle("CD4 early SRT vs later IgG (16 patients)")
  )
  
for(i in SRT)
  print(
    SRT_W2_sero_M5_pat %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG after month 5") +
      ylab(paste0(i, " at W2")) +
      ggtitle("CD8 early SRT vs later IgG (16 patients)")
  )
```

### Correlation of SRT @ W3-6 vs IgG @ M2-4

```{r SRT W3 vs IgG at M2-4, fig.height = 15, fig.width = 10,  tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT W3 vs IgG at M2-4
SRT_W3_sero_M2_pat <- sero %>% 
  left_join(., facs, by = "PatID_Studie1") %>% 
  group_by(PatID_Studie1) %>% 
  rename(Sero_time = Timepoint.x, SRT_time = Timepoint.y) %>% 
  filter(Sero_time == "M2-4", SRT_time == "W3-6")

for(i in SRT)
  print(
    SRT_W3_sero_M2_pat %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales  = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG at M2-4") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD4 early SRT vs later IgG (16 patients)")
  )

for(i in SRT)
  print(
    SRT_W3_sero_M2_pat %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales  = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG at M2-4") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD8 early SRT vs later IgG (16 patients)")
  )
```

### Correlation of SRT @ W3-6 vs IgG after month 5

```{r SRT W3 vs IgG after month 5, fig.height = 15, fig.width = 10,  tidy=TRUE, tidy.opts=list(width.cutoff=60)}
# SRT W3 vs IgG after month 5
SRT_W3_sero_M5_pat <- sero %>% 
  left_join(., facs, by = "PatID_Studie1") %>% 
  group_by(PatID_Studie1) %>% 
  rename(Sero_time = Timepoint.x, SRT_time = Timepoint.y) %>% 
  filter(Sero_time == "after month 5", SRT_time == "W3-6")

for(i in SRT)
  print(
    SRT_W3_sero_M5_pat %>% 
      filter(Marker1 == "CD4") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG after month 5") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD4 early SRT vs later IgG (11 patients)")
  )

for(i in SRT)
  print(
    SRT_W3_sero_M5_pat %>% 
      filter(Marker1 == "CD8") %>% 
      ggplot(aes(x = IgG, y = !!sym(i))) + 
      geom_point(alpha = 0.7, aes(colour = factor(Dexa.x))) + 
      labs(col = "Dexa") +
      scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
      facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                             "CD40L+ IFN-g+","CD40L+ IL-21+",
                                             "CD40L+ TNF-a+","CD137+ GrzB+",
                                             "CD137+ IFN-g+","CD137+ IL-21+",
                                             "CD137+ TNF-a+","CD137+ GrzB-")),
                 scales = "free_y", ncol = 2) +
      stat_cor(method = "spearman", size = 4) +
      #stat_smooth(method = "lm", se = "F") +
      theme_bw() +
      theme(strip.background =element_rect(fill="aliceblue")) +
      xlab("IgG after month 5") +
      ylab(paste0(i, " at W3-6")) +
      ggtitle("CD8 early SRT vs later IgG (11 patients)")
  )
```







## Correlation between SRTs at different timepoints
```{r fig.dim=c(10,8)}
# All markers together
#CD 4
# SRT <- c("S1", "S2", "CEFX", "SEB")
# for(i in SRT)
#   for(j in SRT)
#     if(i != j)
#       print(facs %>%
#         mutate(Timepoint = str_replace(Timepoint, "1", "post vacc")) %>% 
#         filter(Marker1 == "CD4") %>%
#         ggplot(., aes_string(x = i, y = j)) + 
#           geom_point(alpha = 0.5, aes(color = factor(Dexa))) + 
#           labs(col = "Dexa") +
#           scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#           theme_bw() + facet_wrap(.~factor(Timepoint, 
#                                            levels = c('W 2', 'W3-6', 
#                                                       'M2-4', 
#                                                       'after month 5', 
#                                                       'post vacc')),
#                                   scales = "free") +
#           theme(strip.background =element_rect(fill="aliceblue")) +
#           ggtitle("SRT correlation: CD4 cells") + 
#           stat_cor(method = "spearman", 
#                    size = 4))
# 
# # CD 8
# SRT <- c("S1", "S2", "CEFX", "SEB")
# for(i in SRT)
#   for(j in SRT)
#     if(i != j)
#       print(facs  %>%
#         mutate(Timepoint = str_replace(Timepoint, "1", "post vacc"))%>%
#         filter(Marker1 == "CD8") %>%
#         ggplot(., aes_string(x = i, y = j)) + 
#           geom_point(alpha = 0.5, aes(color = factor(Dexa))) + 
#           labs(col = "Dexa") +
#           scale_color_manual(breaks = c("1", "0", "3"),
#                         values=c("orangered", "blue", "green3")) +
#           theme_bw() + facet_wrap(.~factor(Timepoint, 
#                                            levels = c('W 2', 'W3-6', 
#                                                       'M2-4', 
#                                                       'after month 5', 
#                                                       'post vacc')),
#                                   scales = "free") + 
#           theme(strip.background =element_rect(fill="aliceblue")) +
#           ggtitle("SRT correlation: CD8 cells") + 
#           stat_cor(method = "spearman", size = 4))
```

## Correlation between SRTs, separated by markers

```{r, fig.dim=c(10,8)}
# Separate plots for separate markers
# CD 4
SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>%
        filter(Marker1 == "CD4") %>%
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Dexa))) + 
          labs(col = "Dexa") +
          scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                       "CD40L+ IFN-g+","CD40L+ IL-21+",
                                       "CD40L+ TNF-a+","CD137+ GrzB+",
                                       "CD137+ IFN-g+","CD137+ IL-21+",
                                       "CD137+ TNF-a+","CD137+ GrzB-")), 
               scales = "free_y") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("SRT correlation: CD4 cells") + 
          stat_cor(method = "spearman", size = 4))


```

```{r, fig.dim=c(10,8)}
# CD 8
SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>%
        filter(Marker1 == "CD8") %>%
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Dexa))) + 
          labs(col = "Dexa") +
          scale_color_manual(breaks = c("1", "0", "3"),
                        values=c("orangered", "blue", "green3")) +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                       "CD40L+ IFN-g+","CD40L+ IL-21+",
                                       "CD40L+ TNF-a+","CD137+ GrzB+",
                                       "CD137+ IFN-g+","CD137+ IL-21+",
                                       "CD137+ TNF-a+","CD137+ GrzB-")), 
               scales = "free_y") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("SRT correlation: CD8 cells") + 
          stat_cor(method = "spearman", size = 4))


```

\newpage

## Correlation between SRT, separately for each Dexa level
```{r fig.dim=c(10,8)}

# dexa_3 CD4

SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>% 
        filter(Dexa == 3 & Marker1 == "CD4") %>% 
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Timepoint))) + 
          labs(col = "Time point") +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                         "CD40L+ IFN-g+","CD40L+ IL-21+",
                                         "CD40L+ TNF-a+","CD137+ GrzB+",
                                         "CD137+ IFN-g+","CD137+ IL-21+",
                                         "CD137+ TNF-a+","CD137+ GrzB-")),
                                  scales = "free") +
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("Dexa = 3 (mild COVID), CD4 cells") + 
          stat_cor(method = "spearman",size = 4))


# dexa 3 CD8

SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>% 
        filter(Dexa == 3 & Marker1 == "CD8") %>% 
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Timepoint))) + 
          labs(col = "Time point") +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                         "CD40L+ IFN-g+","CD40L+ IL-21+",
                                         "CD40L+ TNF-a+","CD137+ GrzB+",
                                         "CD137+ IFN-g+","CD137+ IL-21+",
                                         "CD137+ TNF-a+","CD137+ GrzB-")),
                                  scales = "free") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("Dexa = 3 (mild COVID), CD8 cells") + 
          stat_cor(method = "spearman", size = 4))

```


```{r dexa_0, fig.dim=c(10,8)}
# dexa_0 CD4

SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>% 
        filter(Dexa == 0 & Marker1 == "CD4") %>%
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Timepoint))) + 
          labs(col = "Time point") +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                         "CD40L+ IFN-g+","CD40L+ IL-21+",
                                         "CD40L+ TNF-a+","CD137+ GrzB+",
                                         "CD137+ IFN-g+","CD137+ IL-21+",
                                         "CD137+ TNF-a+","CD137+ GrzB-")),
                                  scales = "free") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("Dexa = 0 (severe, no dexa), CD4 cells") + 
          stat_cor(method = "spearman", size = 4))

# dexa 0 CD8
SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>% 
        filter(Dexa == 0 & Marker1 == "CD8") %>%
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Timepoint))) + 
          labs(col = "Time point") +
          theme_bw() + 
          facet_wrap(~factor(Marker2, levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                         "CD40L+ IFN-g+","CD40L+ IL-21+",
                                         "CD40L+ TNF-a+","CD137+ GrzB+",
                                         "CD137+ IFN-g+","CD137+ IL-21+",
                                         "CD137+ TNF-a+","CD137+ GrzB-")),
                                  scales = "free") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("Dexa = 0 (severe, no dexa), CD8 cells") + 
          stat_cor(method = "spearman", size = 4))

```

```{r dexa_1, fig.dim = c(10,8)}
# dexa_1 CD4

SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>% 
        filter(Dexa == 1 & Marker1 == "CD4") %>%
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Timepoint))) + 
          labs(col = "Time point") +
          theme_bw() + 
          facet_wrap(~factor(Marker2, 
                             levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                         "CD40L+ IFN-g+","CD40L+ IL-21+",
                                         "CD40L+ TNF-a+","CD137+ GrzB+",
                                         "CD137+ IFN-g+","CD137+ IL-21+",
                                         "CD137+ TNF-a+","CD137+ GrzB-")),
                                  scales = "free") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("Dexa = 1 (severe, dexa treatment), CD4 cells") + 
          stat_cor(method = "spearman", size = 4))

# dexa 1 CD8

SRT <- c("S1", "S2", "CEFX", "SEB")
for(i in SRT)
  for(j in SRT)
    if(i != j)
      print(facs %>% 
        filter(Dexa == 1 & Marker1 == "CD8") %>%
        ggplot(., aes_string(x = i, y = j)) + 
          geom_point(alpha = 0.7, aes(color = factor(Timepoint))) + 
          labs(col = "Time point") +
          theme_bw() + 
          facet_wrap(~factor(Marker2, 
                             levels = c("CD40L+ CD137+","CD40L+ GrzB+",
                                         "CD40L+ IFN-g+","CD40L+ IL-21+",
                                         "CD40L+ TNF-a+","CD137+ GrzB+",
                                         "CD137+ IFN-g+","CD137+ IL-21+",
                                         "CD137+ TNF-a+","CD137+ GrzB-")),
                                  scales = "free") + 
          theme(strip.background =element_rect(fill="aliceblue")) +
          ggtitle("Dexa = 1 (severe, dexa treatment), CD8 cells") + 
          stat_cor(method = "spearman", size = 4))

```

\newpage

<!-- ## Correlation of PNT vs SRT -->
<!-- ```{r SRT_vs_PNT_1, results = 'hide', fig.show = 'all'} -->
<!-- # all dexa levels -->

<!-- strain <- c("B.1.1.7", "B.1.617.2") -->
<!-- SRT <- c("S1", "S2", "CEFX", "SEB") -->

<!-- PNT %>%  -->
<!--   left_join(., facs) %>%  -->
<!--   select(PatID_Studie1, Dexa, Timepoint, S1, S2, CEFX, SEB,  -->
<!--          B.1.1.7, B.1.617.2, Marker1, Marker2) -> PNT_SRT -->

<!-- for(i in SRT) -->
<!--   for(j in strain) -->
<!--     print(PNT_SRT %>% -->
<!--       filter(Marker1 == "CD4") %>% -->
<!--       as.data.frame() %>% -->
<!--       ggplot(., aes_string(x = j, y = i)) + -->
<!--         geom_point(alpha = 0.7, aes(color = factor(Dexa),  -->
<!--                                     shape = factor(Timepoint))) + -->
<!--         scale_color_manual(breaks = c("1", "0", "3"), -->
<!--                         values=c("orangered", "blue", "green3")) + -->
<!--         theme_bw() + -->
<!--         ggtitle("PNT vs SRT correlation: CD4 cells") + -->
<!--         stat_cor(method = "spearman", label.x = 0.2, label.y = 0.2, size = 3)) -->


<!-- for(i in SRT) -->
<!--   for(j in strain) -->
<!--     print(PNT_SRT %>% -->
<!--       filter(Marker1 == "CD8") %>% -->
<!--       as.data.frame() %>% -->
<!--       ggplot(., aes_string(x = j, y = i)) + -->
<!--         geom_point(alpha = 0.7, aes(color = factor(Dexa),  -->
<!--                                     shape = factor(Timepoint))) + -->
<!--         scale_color_manual(breaks = c("1", "0", "3"), -->
<!--                         values=c("orangered", "blue", "green3")) + -->
<!--         theme_bw() + -->
<!--         ggtitle("PNT vs SRT correlation: CD8 cells") + -->
<!--         stat_cor(method = "spearman", label.x = 0.2, label.y = 0.2, size = 3)) -->
<!-- ``` -->


## Cor: live cells vs S1-stim CD4+ CD40L+ CD137+ and CD4+ CD40L+ TNF-a+

```{r, fig.dim=c(10,8)}

facs_live_rows_S1 <- facs_live %>% 
  filter(Marker2 == "CD40L+ CD137+" | Marker2 == "CD40L+ TNF-a+" | Marker2 == "live cells") %>% 
  select(-c("Marker1", "SEB"))
  
facs_live_dcast_S1 <- dcast(facs_live_rows_S1, PatID_Studie1 + Timepoint  ~ Marker2, value.var = "S1") %>% 
  rename(livecells = `live cells`) %>% 
  filter(!is.na(livecells)) #%>% 
  #filter(`CD40L+ TNF-a+` < 2)

marker <- c("CD40L+ CD137+", "CD40L+ TNF-a+")
for(i in marker)
  print(facs_live_dcast_S1 %>%
    group_by(PatID_Studie1, Timepoint) %>% 
    ggplot(aes(x = !!sym(i), y = livecells)) + 
      geom_point(alpha = 0.7) + #, aes(color = factor(Dexa))
      # labs(col = "Dexa") +
      # scale_color_manual(breaks = c("1", "0", "3"),
      #               values=c("orangered", "blue", "green3")) +
      theme_bw() + 
      #facet_wrap() + 
      ylab("S1 live cells") +
      theme(strip.background =element_rect(fill="aliceblue")) +
      stat_cor(method = "spearman", size = 4))
## SEB
facs_live_rows_SEB <- facs_live %>% 
  filter(Marker2 == "CD40L+ CD137+" | Marker2 == "CD40L+ TNF-a+" | Marker2 == "live cells") %>% 
  select(-c("Marker1", "S1"))
  
facs_live_dcast_SEB <- dcast(facs_live_rows_SEB, PatID_Studie1 + Timepoint  ~ Marker2, value.var = "SEB") %>% 
  rename(livecells = `live cells`) %>% 
  filter(!is.na(livecells)) #%>% 
  #filter(`CD40L+ TNF-a+` < 2)

marker <- c("CD40L+ CD137+", "CD40L+ TNF-a+")
for(i in marker)
  print(facs_live_dcast_SEB %>%
    group_by(PatID_Studie1, Timepoint) %>% 
    ggplot(aes(x = !!sym(i), y = livecells)) + 
      geom_point(alpha = 0.7) + #, aes(color = factor(Dexa))
      # labs(col = "Dexa") +
      # scale_color_manual(breaks = c("1", "0", "3"),
      #               values=c("orangered", "blue", "green3")) +
      theme_bw() + 
      #facet_wrap() + 
      ylab("SEB live cells") +
      theme(strip.background =element_rect(fill="aliceblue")) +
      stat_cor(method = "spearman", size = 4))
```

```{r xml_handling}
require(XML)
library("methods")

# read xml file
xmldataframe <- xmlToDataFrame("../LabAllClean2110.xml")

measurements <- c("CRP", "CRP HP",
                  "procalcitonin", "procalcitonin HP",
                  "Leukozyten", "Leukozyten abs. (WBC/TNC)",
                  "Ferritin", "Ferritin HP",
                  "Interleukin-6",
                  "LDH",
                  "Lymphozyten",
                  "Neutrophilen")

xmldataframe %>% 
  filter(str_detect(N2LABOR001_N2KATTEXT, measurements)) -> selected_measurements
```