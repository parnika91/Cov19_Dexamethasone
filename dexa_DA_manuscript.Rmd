---
title: "Dexamethasone treatment - Manuscript figures"
output:
  pdf_document: default
  html_document:
    df_print: paged
  toc: TRUE
---

```{r, echo = F}
knitr::opts_chunk$set(warning = F, message = F)
knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
#knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80),tidy=TRUE)

```

```{r load_libraries, echo = F, message = F, warning = F}
library(readxl)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(reshape2)
library(broom)
library(stringr)
#library(ggstatsplot)
```


```{r load_datasets}
# delta alpha clinical table
PNT <- read_excel("../2021-12-30_Dexa_Charite_UKK_PSV_all results a and d sanity check pending.xlsx") %>% 
  select(`sanity check needed`,
         contains("Studie 1 von 2012-12-30_all results +basic clinical"),
         contains("PatID Studie 1"),
         contains("exclude"),
         contains("Tag PSO"),
         contains("PSO/PI"),
         contains("Zeitraum corrected"),
         contains("Serum"),
         contains("Dexa")) %>% 
  rename(sanity = `sanity check needed`,
         Studie1 = `Studie 1 von 2012-12-30_all results +basic clinical`,
         PatID_Studie1 = `PatID Studie 1 von 2012-12-30_all results +basic clinical`, 
         exclude_immuno = `# exclude (immunosuppression, other)`,
         exclude_B.1.1.7 = `#exclude for B1.1.7`,
         exclude_B.1.617.2 = `#exclude for B.1.617.2`,
         TagPSO = `Tag PSO`,
         Timepoint = `Zeitraum corrected`,
         B.1.1.7 = `Serum ID50: Variant B.1.1.7`, 
         B.1.617.2 = `Serum ID50: Variant B.1.617.2`,
         Dexa = `Dexamethason von 2012-12-30_all results +basic clinical`) %>%
  mutate(PatID_Studie1 = str_replace(PatID_Studie1, c("C19-CB-"), "")) %>% 
  mutate(PatID_Studie1 = as.character(as.numeric(PatID_Studie1))) %>% 
  mutate(TagPSO = as.numeric(TagPSO)) %>%
  mutate(Studie1 = str_replace(Studie1, c("Pa-COVID-19"), "Pa-COVID")) %>% 
  mutate(PatID_Studie1 = paste(tolower(paste(substr(Studie1, 1, 2))), 
                               tolower(paste(substr(Studie1, (nchar(Studie1)-1), nchar(Studie1)), 
                                             PatID_Studie1, 
                                             sep = "")),
                               sep = "")) %>%
  mutate(sanity = as.numeric(replace_na(sanity, "0"))) %>% 
  filter(sanity == 0) %>% 
  mutate(exclude_immuno = as.numeric(replace_na(exclude_immuno, "0"))) %>% 
  filter(exclude_immuno == 0) %>% 
  mutate(exclude_B.1.1.7 = as.numeric(replace_na(exclude_B.1.1.7, "0"))) %>% 
  mutate(exclude_B.1.617.2 = as.numeric(replace_na(exclude_B.1.617.2, "0")))

# FACS results
facs <- read_excel("../20220104 Mastertable FACS incl. dead and VC.xlsx") %>% 
  select("Studie 1", 
         "PatID Studie 1", 
         "timepoints 2022", 
         "Tag PSO", 
         "Dexa", 
         "Marker 1", 
         "Marker 2", 
         "#CEFX-unstim negativ auf 0", 
         "#S1-unstim negativ auf 0", 
         "#S2-unstim negativ auf 0", 
         "#SEB-unstim negativ auf 0",
         "ausschliessen") %>%
  mutate(ausschliessen = replace_na(ausschliessen, 0)) %>% 
  rename(Studie1 = `Studie 1`, 
         PatID_Studie1 = `PatID Studie 1`, 
         Timepoint = `timepoints 2022`,
         TagPSO = `Tag PSO`, 
         Marker1 = `Marker 1`, 
         Marker2 = `Marker 2`) %>%
  rename(CEFX = `#CEFX-unstim negativ auf 0`, 
         S1 = `#S1-unstim negativ auf 0`, 
         S2 = `#S2-unstim negativ auf 0`, 
         SEB = `#SEB-unstim negativ auf 0`) %>%
  filter(!is.na(CEFX) | !is.na(S1) | !is.na(S2) | !is.na(SEB)) %>%
  mutate(PatID_Studie1 = as.character(PatID_Studie1)) %>% 
  mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153")) %>% 
  filter(!(ausschliessen == 1)) %>% 
  mutate(Studie1 = str_replace(Studie1, c("Pa-COVID-19"), "Pa-COVID")) %>% 
  mutate(PatID_Studie1_short = paste(tolower(paste(substr(Studie1, 1, 2))), 
                               tolower(paste(substr(Studie1, (nchar(Studie1)-1), nchar(Studie1)), 
                                             PatID_Studie1, 
                                             sep = "")),
                               sep = "")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("1"), "PI")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("M2-4"), "M3")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("after month 5"), "M5+")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("W3-6"), "W4")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("W 2"), "W2"))


# meta data
meta <- read_excel("../metadata_all_patients_2022 01 04 CT.xlsx") %>%
  select(contains("sanity"),
         contains("Studie 1"),
         contains("Alter / Geschaetztes Alter bei Einschluss gr 3 Jahre"),
         contains("Geschlecht bei der Geburt"),
         contains("Dexamethason"),
         contains("Immunosuppression"),
         contains("Bemerkung"),
         contains("Start Dexa"),
         contains("Ende Dexa")) %>% 
  rename(PatID_Studie1 = `PatID Studie 1`, 
         Age = `Alter / Geschaetztes Alter bei Einschluss gr 3 Jahre`, 
         Sex = `Geschlecht bei der Geburt` ,
         Studie1 = `Studie 1`) %>%
  mutate(PatID_Studie1 = as.character(PatID_Studie1)) %>% 
  filter(!grepl(.$Bemerkung, pattern = "Immun", ignore.case = T)) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153")) %>% 
  mutate(PatID_Studie1 = str_replace(PatID_Studie1, c("C19-CB-"), "")) %>%
  mutate(PatID_Studie1 = as.character(as.numeric(PatID_Studie1))) %>% 
  mutate(Studie1 = str_replace(Studie1, c("Pa-COVID-19"), "Pa-COVID")) %>% 
  mutate(PatID_Studie1 = paste(tolower(paste(substr(Studie1, 1, 2))), 
                               tolower(paste(substr(Studie1, (nchar(Studie1)-1), nchar(Studie1)), 
                                             PatID_Studie1, 
                                             sep = "")),
                               sep = ""))

# serology
sero <- read_excel("../all results serology 2021 12 and 10 sanity checks CT 22 01 04.xlsx") %>% 
  select(contains("sanity"),
         contains("Studie 1"),
         contains("Entnahmedatum"),
         contains("Tag PSO"),
         contains("Bemerkung"),
         contains("Zeitraum"),
         contains("IgG"),
         contains("Dexa"),
         contains("ausschliessen (Immunsuppression, other)")) %>% 
  rename(PatID_Studie1 = `PatID Studie 1`,
         Studie1 = `Studie 1`,
         IgG = `IgG Value BAU/ml >=7.1 reactive`,
         TagPSO = `Tag PSO`, 
         Timepoint = Zeitraum, 
         Dexa = `Dexamethason`,
         ausschliessen_imm = `ausschliessen (Immunsuppression, other)`,
         sanity = "needs sanity check") %>% 
  mutate(ausschliessen_imm = replace_na(ausschliessen_imm, 0)) %>%
  mutate(PatID_Studie1 = str_replace(PatID_Studie1, c("C19-CB-"), "")) %>% 
  mutate(PatID_Studie1 = as.character(as.numeric(PatID_Studie1))) %>% 
  mutate(IgG = as.numeric(str_replace(IgG, c(","), "\\."))) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153")) %>% 
  filter(!ausschliessen_imm == 1) %>% 
  mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) %>% 
  mutate(Studie1 = str_replace(Studie1, c("Pa-COVID-19"), "Pa-COVID")) %>% 
  mutate(PatID_Studie1 = str_replace(PatID_Studie1, c("C19-CB-"), "")) %>%
  mutate(PatID_Studie1 = as.character(as.numeric(PatID_Studie1))) %>% 
  mutate(PatID_Studie1 = paste(tolower(paste(substr(Studie1, 1, 2))), 
                               tolower(paste(substr(Studie1, (nchar(Studie1)-1), nchar(Studie1)), 
                                             PatID_Studie1, 
                                             sep = "")),
                               sep = "")) %>% 
  mutate(sanity = as.numeric(replace_na(sanity, "0"))) %>% 
  filter(sanity == 0)

SRT <- c("S1", "S2")
strain <- c("B.1.1.7", "B.1.617.2")
level_order <- c('1', '0', '3')

## How many patients have at least three time points in each measurement.
# facs_pat_3timepoints <- facs %>%
#   select(PatID_Studie1, Timepoint) %>%
#   distinct() %>%
#   group_by(PatID_Studie1) %>%
#   mutate(number_of_FACS_timepoints = n()) %>%
#   mutate(measured_at = paste0(Timepoint, collapse = ", ")) %>%
#   select(!Timepoint) %>%
#   distinct()
# write.table(facs_pat_3timepoints, "FACS_measurement_timepoints.tsv", row.names = F, quote = F, sep = "\t")
# 
# PNT_pat_3timepoints <- PNT %>%
#   select(PatID_Studie1, Days) %>%
#   distinct() %>%
#   group_by(PatID_Studie1) %>%
#   mutate(number_of_PNT_timepoints = n()) %>%
#   mutate(measured_at = paste0(Days, collapse = ", ")) %>%
#   select(!Days) %>%
#   distinct()
# write.table(PNT_pat_3timepoints, "PNT_measurement_timepoints.tsv", row.names = F, quote = F, sep = "\t")
# 
# sero_pat_3timepoints <- sero %>%
#   select(PatID_Studie1, Timepoint) %>%
#   distinct() %>%
#   group_by(PatID_Studie1) %>%
#   mutate(number_of_Sero_timepoint = n()) %>%
#   mutate(measured_at = paste0(Timepoint, collapse = ", ")) %>%
#   select(!Timepoint) %>%
#   distinct()
# write.table(sero_pat_3timepoints, "Serology_measurement_timepoints.tsv", row.names = F, quote = F, sep = "\t")

```

```{r tables_for_Lara}

# convert facs table to wide format for selected markers, for each patient
facs_wide <- read_excel("../20220104 Mastertable FACS incl. dead and VC.xlsx") %>% 
  select("Studie 1", 
         "PatID Studie 1", 
         "timepoints 2022", 
         "Dexa", 
         "Marker 1", 
         "Marker 2", 
         "#S1-unstim log", 
         "#S2-unstim log", 
         "ausschliessen") %>%
  mutate(ausschliessen = replace_na(ausschliessen, 0)) %>% 
  rename(Studie1 = `Studie 1`, 
         PatID_Studie1 = `PatID Studie 1`, 
         Timepoint = `timepoints 2022`,
         Marker1 = `Marker 1`, 
         Marker2 = `Marker 2`,
         S1 = `#S1-unstim log`, 
         S2 = `#S2-unstim log`) %>%
  filter(!is.na(S1) | !is.na(S2)) %>%
  mutate(PatID_Studie1 = as.character(PatID_Studie1)) %>% 
  mutate(Timepoint = replace(Timepoint, PatID_Studie1=="435", "W 2")) %>% 
  filter(!(PatID_Studie1 == "183" | 
           PatID_Studie1 == "22" | 
           PatID_Studie1 == "53" | 
           PatID_Studie1 == "88" | 
           PatID_Studie1 == "115" | 
           PatID_Studie1 == "120" | 
           PatID_Studie1 == "133" | 
           PatID_Studie1 == "153")) %>% 
  filter(!(ausschliessen == 1)) %>% 
  mutate(Studie1 = str_replace(Studie1, c("Pa-COVID-19"), "Pa-COVID")) %>% 
  mutate(PatID_Studie1_short = paste(tolower(paste(substr(Studie1, 1, 2))), 
                               tolower(paste(substr(Studie1, (nchar(Studie1)-1), nchar(Studie1)), 
                                             PatID_Studie1, 
                                             sep = "")),
                               sep = "")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("1"), "PI")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("M2-4"), "M3")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("after month 5"), "M5+")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("W3-6"), "W4")) %>% 
  mutate(Timepoint = str_replace(Timepoint, c("W 2"), "W2"))

### S1 ###

# 1 #
CD40CD137 <- facs_wide %>% 
  filter(Marker2 == "CD40L+ CD137+") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S1) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S1,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S1", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$PI[[i]][1]))
    postvac[i] <- CD40CD137$PI[[i]][1]
CD40CD137$PI <-postvac

W2 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$W2[[i]][1]))
    W2[i] <- CD40CD137$W2[[i]][1]
CD40CD137$W2 <-W2

W4 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$W4[[i]][1]))
    W4[i] <- CD40CD137$W4[[i]][1]
CD40CD137$W4 <-W4

M3 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$M3[[i]][1]))
    M3[i] <- CD40CD137$M3[[i]][1]
CD40CD137$M3 <-M3

M5 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$`M5+`[[i]][1]))
    M5[i] <- CD40CD137$`M5+`[[i]][1]
CD40CD137$`M5+` <-M5

# 2 #
CD40TNF <- facs_wide %>% 
  filter(Marker2 == "CD40L+ TNF-a+") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S1) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S1,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S1", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$PI[[i]][1]))
    postvac[i] <- CD40TNF$PI[[i]][1]
CD40TNF$PI <-postvac

W2 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$W2[[i]][1]))
    W2[i] <- CD40TNF$W2[[i]][1]
CD40TNF$W2 <-W2

W4 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$W4[[i]][1]))
    W4[i] <- CD40TNF$W4[[i]][1]
CD40TNF$W4 <-W4

M3 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$M3[[i]][1]))
    M3[i] <- CD40TNF$M3[[i]][1]
CD40TNF$M3 <-M3

M5 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$`M5+`[[i]][1]))
    M5[i] <- CD40TNF$`M5+`[[i]][1]
CD40TNF$`M5+` <-M5


# 3 #
CD40IL21 <- facs_wide %>% 
  filter(Marker2 == "CD40L+ IL-21+") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S1) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S1,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S1", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$PI[[i]][1]))
    postvac[i] <- CD40IL21$PI[[i]][1]
CD40IL21$PI <-postvac

W2 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$W2[[i]][1]))
    W2[i] <- CD40IL21$W2[[i]][1]
CD40IL21$W2 <-W2

W4 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$W4[[i]][1]))
    W4[i] <- CD40IL21$W4[[i]][1]
CD40IL21$W4 <-W4

M3 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$M3[[i]][1]))
    M3[i] <- CD40IL21$M3[[i]][1]
CD40IL21$M3 <-M3

M5 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$`M5+`[[i]][1]))
    M5[i] <- CD40IL21$`M5+`[[i]][1]
CD40IL21$`M5+` <-M5

# 4 #
livecells <- facs_wide %>% 
  filter(Marker2 == "live cells") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S1) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S1,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S1", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$PI[[i]][1]))
    postvac[i] <- livecells$PI[[i]][1]
livecells$PI <-postvac

W2 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$W2[[i]][1]))
    W2[i] <- livecells$W2[[i]][1]
livecells$W2 <-W2

W4 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$W4[[i]][1]))
    W4[i] <- livecells$W4[[i]][1]
livecells$W4 <-W4

M3 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$M3[[i]][1]))
    M3[i] <- livecells$M3[[i]][1]
livecells$M3 <-M3

M5 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$`M5+`[[i]][1]))
    M5[i] <- livecells$`M5+`[[i]][1]
livecells$`M5+` <-M5

write.csv(CD40CD137, file = "../S1_CD40CD137.csv", row.names = F, quote = F)
write.csv(CD40TNF, file = "../S1_CD40TNF.csv", row.names = F, quote = F)
write.csv(CD40CD137, file = "../S1_CD40IL21.csv", row.names = F, quote = F)
write.csv(CD40CD137, file = "../S1_livecells.csv", row.names = F, quote = F)



```

```{r S2}
### S2 ###

# 1 #
CD40CD137 <- facs_wide %>% 
  filter(Marker2 == "CD40L+ CD137+") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S2) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S2,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S2", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$PI[[i]][1]))
    postvac[i] <- CD40CD137$PI[[i]][1]
CD40CD137$PI <-postvac

W2 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$W2[[i]][1]))
    W2[i] <- CD40CD137$W2[[i]][1]
CD40CD137$W2 <-W2

W4 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$W4[[i]][1]))
    W4[i] <- CD40CD137$W4[[i]][1]
CD40CD137$W4 <-W4

M3 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$M3[[i]][1]))
    M3[i] <- CD40CD137$M3[[i]][1]
CD40CD137$M3 <-M3

M5 <- c()
for(i in 1:nrow(CD40CD137))
  if(!is.null(CD40CD137$`M5+`[[i]][1]))
    M5[i] <- CD40CD137$`M5+`[[i]][1]
CD40CD137$`M5+` <-M5

# 2 #
CD40TNF <- facs_wide %>% 
  filter(Marker2 == "CD40L+ TNF-a+") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S2) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S2,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S2", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$PI[[i]][1]))
    postvac[i] <- CD40TNF$PI[[i]][1]
CD40TNF$PI <-postvac

W2 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$W2[[i]][1]))
    W2[i] <- CD40TNF$W2[[i]][1]
CD40TNF$W2 <-W2

W4 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$W4[[i]][1]))
    W4[i] <- CD40TNF$W4[[i]][1]
CD40TNF$W4 <-W4

M3 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$M3[[i]][1]))
    M3[i] <- CD40TNF$M3[[i]][1]
CD40TNF$M3 <-M3

M5 <- c()
for(i in 1:nrow(CD40TNF))
  if(!is.null(CD40TNF$`M5+`[[i]][1]))
    M5[i] <- CD40TNF$`M5+`[[i]][1]
CD40TNF$`M5+` <-M5


# 3 #
CD40IL21 <- facs_wide %>% 
  filter(Marker2 == "CD40L+ IL-21+") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S2) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S2,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S2", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$PI[[i]][1]))
    postvac[i] <- CD40IL21$PI[[i]][1]
CD40IL21$PI <-postvac

W2 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$W2[[i]][1]))
    W2[i] <- CD40IL21$W2[[i]][1]
CD40IL21$W2 <-W2

W4 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$W4[[i]][1]))
    W4[i] <- CD40IL21$W4[[i]][1]
CD40IL21$W4 <-W4

M3 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$M3[[i]][1]))
    M3[i] <- CD40IL21$M3[[i]][1]
CD40IL21$M3 <-M3

M5 <- c()
for(i in 1:nrow(CD40IL21))
  if(!is.null(CD40IL21$`M5+`[[i]][1]))
    M5[i] <- CD40IL21$`M5+`[[i]][1]
CD40IL21$`M5+` <-M5

# 4 #
livecells <- facs_wide %>% 
  filter(Marker2 == "live cells") %>% 
  select(Studie1,
         PatID_Studie1,
         PatID_Studie1_short,
         Dexa,
         Timepoint,
         Marker2,
         S2) %>% 
  group_by(Timepoint) %>%
  mutate(row = row_number()) %>%
  tidyr::pivot_wider(id_cols = c(PatID_Studie1, Studie1, PatID_Studie1_short, Dexa, Marker2), 
                     names_from = Timepoint, 
                     values_from = S2,
                     values_fn = list) %>% 
  mutate(Stimulation = rep("S2", nrow(.))) %>% 
  mutate(PI = na_if(PI, c("NULL"))) %>%
  mutate(W2 = na_if(W2, c("NULL"))) %>%
  mutate(W4 = na_if(W4, c("NULL"))) %>%
  mutate(M3 = na_if(M3, c("NULL"))) %>%
  mutate(`M5+` = na_if(`M5+`, c("NULL")))

postvac <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$PI[[i]][1]))
    postvac[i] <- livecells$PI[[i]][1]
livecells$PI <-postvac

W2 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$W2[[i]][1]))
    W2[i] <- livecells$W2[[i]][1]
livecells$W2 <-W2

W4 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$W4[[i]][1]))
    W4[i] <- livecells$W4[[i]][1]
livecells$W4 <-W4

M3 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$M3[[i]][1]))
    M3[i] <- livecells$M3[[i]][1]
livecells$M3 <-M3

M5 <- c()
for(i in 1:nrow(livecells))
  if(!is.null(livecells$`M5+`[[i]][1]))
    M5[i] <- livecells$`M5+`[[i]][1]
livecells$`M5+` <-M5

write.csv(CD40CD137, file = "../S2_CD40CD137.csv", row.names = F, quote = F)
write.csv(CD40TNF, file = "../S2_CD40TNF.csv", row.names = F, quote = F)
write.csv(CD40CD137, file = "../S2_CD40IL21.csv", row.names = F, quote = F)
write.csv(CD40CD137, file = "../S2_livecells.csv", row.names = F, quote = F)
```